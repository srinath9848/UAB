@model List<UAB.DTO.ChartSummaryDTO>
@{
    ViewData["Title"] = "QA";
}
<form asp-action="SubmitQAAvailableChart" id="form1" asp-controller="UAB" method="POST">
    <div class="container-fluid">
        <div class="row">
            <partial name="_InitialData" model=Model.FirstOrDefault() />
            <partial name="_RebuttalChartDetails" model=Model />
        </div>
    </div>
</form>
<script src="~/dashboardassets/libs/jquery/dist/jquery.min.js"></script>
<script src="~/dashboardassets/libs/jquery-validation/dist/jquery.validate.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validation-unobtrusive/3.2.11/jquery.validate.unobtrusive.min.js" type="text/javascript"></script>
<script type="text/javascript">

    $(".CoderDetails").css("pointer-events", "none");
    $(".CoderDetails").css("background-color", "#e9ecef");
    $(".QADetails").attr("readonly", false);
    $("#qa").addClass('selected');
    $(".accept").removeClass('accept');



    var isBlocked = @(ViewBag.IsBlocked == null ? "0": "1");

    if (isBlocked == 1) {
        $("#btnBlock").hide();
        $("#btnBlockHistory").show();
        $("#btnPrevious").show();
        $("#btnNext").show();
    }


    $('#chkAll').change(function () {
        if ($(this).is(':checked')) {
            $('.fa-check-circle').addClass('accept');
            $('.fa-times-circle').removeClass('reject')
            $('.QARevised').css("display", "none");
            $(".QARevised").val('');

            $("[class*=DxRemarks_]").val('');
            $("[class*=DxRemarks_]").hide();

            $("[class*=Dx_]").val('');
            $("[class*=Dx_]").hide();

            $("[class*=Cpt_]").val('');
            $("[class*=Cpt_]").hide();

            $(".CodingDetails").hide();
            $(".errMsg").text('');
            $("#QADTO_ErrorType").css("pointer-events", "none");
            $(".ErrorType").text('');
            $(".QACorrectionsComments").hide();
        }
        else {
            $('.fa-check-circle').removeClass('accept');
            $("#QADTO_ErrorType").css("pointer-events", "auto");
        }
    });

    $('span i').click(function () {
        var id = $(this).attr('id');
        if ($(this).hasClass('fa-check-circle')) {
            $(this).toggleClass('accept');
            $(this).siblings().removeClass('reject');
            $("." + id).css("display", "none");
            $("#" + id + "1").css("display", "none");
            $("#" + id + "2").css("display", "none");
            $("#" + id + "1").val('');
            $("." + id).val('');
            $("#" + id + "2").val('');
            var total = $(".lessWidth").find(".fa-check-circle").length;
            var accept = $(".lessWidth").find(".accept").length;
            if (total == accept) {
                $("#chkAll").prop('checked', true);
                $("#QADTO_ErrorType").val('');
                $("#QADTO_ErrorType").css("pointer-events", "none");
                $(".ErrorType").text('');
                $(".errMsg").text('');
                $(".QACorrectionsComments").hide();
            }
        }
        else if ($(this).hasClass('fa-times-circle')) {
            $(this).toggleClass('reject');
            $(this).siblings().removeClass('accept');
            $("." + id).css("display", "flex");
            $("#" + id + "1").css("display", "flex");
            $("#" + id + "2").css("display", "flex");
            $("#chkAll").prop('checked', false);
            $("#QADTO_ErrorType").css("pointer-events", "auto");
            $(".QACorrectionsComments").show();
        }
    });

    $("#QADTO_ErrorType").change(function () {
        if ($(this).val() != "") {
            $(".ErrorType").text('');
        }
    });

    $('#btnsubmit,#SubmitAndGetNext').click(function (e) {

        var Dxremarks = $("[class*=DxRemarks_]");
        $("#hdnQADxRemarks").val("");
        for (var i = 0; i < Dxremarks.length; i++) {

            if ($(Dxremarks[i]).css("display") == "flex") {

                var id = parseInt($(Dxremarks[i]).attr("id").split("_")[1]);

                if ($("#hdnQADxRemarks").val() == "")
                    $("#hdnQADxRemarks").val(id + "^" + $(Dxremarks[i]).val());
                else
                    $("#hdnQADxRemarks").val($("#hdnQADxRemarks").val() + "|" + id + "^" + $(Dxremarks[i]).val());
            }
        }

        var DxCodes = $("[id*=txtDx_]");
        $("#hdnQADxCodes").val("");
        for (var i = 0; i < DxCodes.length; i++) {

            var id = parseInt($(DxCodes[i]).attr("id").split("_")[1]);

            if ($(".DxRemarks_" + id).length) {

                if ($("#" + $(DxCodes[i]).attr("id")).val() != "" &&
                    $(".Dx_" + id).css("display") == "flex") {

                    if ($("#hdnQADxCodes").val() == "")
                        $("#hdnQADxCodes").val(id + "^" + $(DxCodes[i]).val());
                    else
                        $("#hdnQADxCodes").val($("#hdnQADxCodes").val() + "|" + id + "^" + $(DxCodes[i]).val());
                }
            }
            else {
                if ($("#" + $(DxCodes[i]).attr("id")).val() != "") {

                    if ($("#hdnQADxCodes").val() == "")
                        $("#hdnQADxCodes").val(id + "^" + $(DxCodes[i]).val());
                    else
                        $("#hdnQADxCodes").val($("#hdnQADxCodes").val() + "|" + id + "^" + $(DxCodes[i]).val());
                }
            }
        }

        var CptRemarks = $("[class*=CptRemarks_]");
        $("#hdnQACptRemarks").val("");
        for (var i = 0; i < CptRemarks.length; i++) {

            var id = parseInt($(CptRemarks[i]).attr("id").split("_")[1]);

            if ($(CptRemarks[i]).css("display") == "flex") {

                if ($("#hdnQACptRemarks").val() == "")
                    $("#hdnQACptRemarks").val(id + "^" + $(CptRemarks[i]).val());
                else
                    $("#hdnQACptRemarks").val($("#hdnQACptRemarks").val() + "|" + id + "^" + $(CptRemarks[i]).val());
            }
        }

        var CptCodes = $("[id*=DivCptRow_]");
        $("#hdnQACptCodes").val("");
        for (var i = 1; i <= CptCodes.length; i++) {
            var id = parseInt($("#txtCpt_" + i).attr("id").split("_")[1]);
            if ($(".CptRemarks_" + id).length) {
                if ($("#txtCpt_" + i).val() != "" && $(".Cpt_" + id).css("display") == "flex") {
                    if ($("#hdnQACptCodes").val() == "") {
                        if ($("#txtCpt_" + i).val() != "") {
                            var mod = $("#txtMod_" + i).val() != "" ? $("#txtMod_" + i).val() : null;
                            var qty = $("#txtQty_" + i).val() != "" ? $("#txtQty_" + i).val() : null;
                            var links = $("#txtLinks_" + i).val() != "" ? $("#txtLinks_" + i).val() : null;
                            $("#hdnQACptCodes").val(id + "^" + $("#txtCpt_" + i).val() + "^" + mod + "^" + qty + "^" + links);
                        }
                    }
                    else {
                        if ($("#txtCpt_" + i).val() != "") {
                            var mod = $("#txtMod_" + i).val() != "" ? $("#txtMod_" + i).val() : null;
                            var qty = $("#txtQty_" + i).val() != "" ? $("#txtQty_" + i).val() : null;
                            var links = $("#txtLinks_" + i).val() != "" ? $("#txtLinks_" + i).val() : null;
                            $("#hdnQACptCodes").val($("#hdnQACptCodes").val() + "|" + id + "^" + $("#txtCpt_" + i).val() + "^" + mod + "^" + qty + "^" + links);
                        }
                    }
                }
            }
            else {
                if ($("#txtCpt_" + i).val() != "") {
                    if ($("#hdnQACptCodes").val() == "") {
                        var mod = $("#txtMod_" + i).val() != "" ? $("#txtMod_" + i).val() : null;
                        var qty = $("#txtQty_" + i).val() != "" ? $("#txtQty_" + i).val() : null;
                        var links = $("#txtLinks_" + i).val() != "" ? $("#txtLinks_" + i).val() : null;
                        $("#hdnQACptCodes").val(id + "^" + $("#txtCpt_" + i).val() + "^" + mod + "^" + qty + "^" + links);
                    }
                    else {
                            var mod = $("#txtMod_" + i).val() != "" ? $("#txtMod_" + i).val() : null;
                            var qty = $("#txtQty_" + i).val() != "" ? $("#txtQty_" + i).val() : null;
                            var links = $("#txtLinks_" + i).val() != "" ? $("#txtLinks_" + i).val() : null;
                            $("#hdnQACptCodes").val($("#hdnQACptCodes").val() + "|" + id + "^" + $("#txtCpt_" + i).val() + "^" + mod + "^" + qty + "^" + links);
                    }
                }
            }
        }

        var total = $(".fa-check-circle").length;
        var reject = $(".reject:not(.ignore)").length
        var accept = $(".accept").length;

        if (total != accept && $("#QADTO_ErrorType").val() == "") {
            $(".ErrorType").html('<span id="projectdd-error" class="">ErrorType is required.</span>');
            e.preventDefault();
        }
        if (total != accept + reject) {
            $("#validationPopUp").show();
            e.preventDefault();
        }

    });

    validationPopUp = function () {
        $("#validationPopUp").hide();
    };

    var dxArray = [];
    function DxFunction(txt_0) {
        var id = parseInt(txt_0.split("_")[1]) + parseInt(1);
        if (txt_0.split("_")[1] !== undefined) {
            var currId = parseInt(id) - parseInt(1);
            var val = $("#txtDx_" + currId).val();
            if (val !== "" && val !== null) {
                if ($.inArray(val, dxArray) == -1) {
                    dxArray.push(val);
                    $("#Dx").val(dxArray);
                    var text = "'" + "txtDx_" + id + "'";
                    $("#DivDx").append('<div id="DivDxRow_' + id + '" class="form-group row"><label class= "col-md-3 lessWidth m-t-15" ></label><div class="col-md-3 input-group"></div><div class="col-md-3 lessWidth input-group"><div class="input-group-prepend ControlHeight"><span class="input-group-text" id="basic-addon1">' + id + '</span></div><input type="text" placeholder="Code" tabindex="' + id + '" onfocusout="DxFunction(' + text + ')" class="form-control CoderDetails ControlHeight txtDx" id="txtDx_' + id + '" /></div></div>');
                    $("#txtDx_" + currId).removeAttr("onfocusout", "");
                    $("#txtDx_" + id).focus();
                }
            } else {
                //var id2 = parseInt(id) - parseInt(1);
                //var val = $("#txt" + id2).val();
                //if (val == "") {
                //    if (id2 !== 0) {
                //        dxArray.splice(id2, id2);
                //        $("#Dx").val(dxArray);
                //        $('#tr' + id2).remove();
                //        //$("#txt" + id2).focus();
                //    }
                //}
            }
        }
    }

    var cptArray = [];
    function CptFunction(txtCpt_0) {
        var id = parseInt(txtCpt_0.split("_")[1]) + parseInt(1);
        if (txtCpt_0.split("_")[1] !== undefined) {
            var id1 = parseInt(id) - parseInt(1);
            var val1 = $("#txtCpt_" + id1).val();

            var val2 = null;
            if ($("#txtMod_" + id1).val() != "")
                val2 = $("#txtMod_" + id1).val().replace(",", "|");

            var val3 = null;
            if ($("#txtQty_" + id1).val() != "")
                val3 = $("#txtQty_" + id1).val();

            var val4 = null;
            if ($("#txtLinks_" + id1).val() != "")
                val4 = $("#txtLinks_" + id1).val().replace(",", "|");

            if (val1 !== "") {
                if ($.inArray(val1, cptArray) == -1) {
                    cptArray.push(val1 + "^" + val2 + "^" + val3 + "^" + val4);
                    $("#CPTCode").val(cptArray);
                    var count = id + parseInt(1);
                    var txtLinks = "'" + "txtLinks_" + id + "'";
                    var tabindex1 = parseInt(9) + parseInt(id) + parseInt(count) + parseInt(val1);
                    var tabindex2 = parseInt(10) + parseInt(id) + parseInt(count) + parseInt(val1);
                    var tabindex3 = parseInt(11) + parseInt(id) + parseInt(count) + parseInt(val1);
                    var tabindex4 = parseInt(12) + parseInt(id) + parseInt(count) + parseInt(val1);
                    $("#DivCpt").append('<div id="DivCptRow_' + id + '" class="form-group row"><label class="col-md-3 lessWidth m-t-15"></label><div class="col-md-3 CptlessWidth input-group"></div ><div class="col-md-3 CptlessWidth input-group"><div class="input-group-prepend ControlHeight"><span class="input-group-text" id="basic-addon1">' + id + '</span></div><input tabindex = "' + tabindex1 + '" type = "text" placeholder = "Code" class= "form-control CoderDetails ControlHeight txtCpt" id = "txtCpt_' + id + '" /><input tabindex="' + tabindex2 + '" type="text" class="form-control CoderDetails ControlHeight" placeholder="Mod" id="txtMod_' + id + '"/><input tabindex="' + tabindex3 + '" type="text" class="form-control CoderDetails ControlHeight" placeholder="1" value="1" id="txtQty_' + id + '"/><input tabindex="' + tabindex4 + '" type="text" class="form-control CoderDetails ControlHeight" placeholder="Link All" onfocusout="CptFunction(' + txtLinks + ')" id="txtLinks_' + id + '"/></div></div>');
                    $("#txtLinks_" + id1).removeAttr("onfocusout", "");
                    $("#txtCpt_" + id).focus();
                }

            } else {
                //var id2 = parseInt(id) - parseInt(1);
                //var val = $("#txtCpt" + id2).val();
                //if (val == "") {
                //    if (id2 !== 0) {
                //        cptArray.splice(id2, id2);
                //        $("#CPTCode").val(cptArray);
                //        $('#cpttr' + id2).remove();
                //        //$("#CPTCode" + id2).focus();
                //    }
                //}
            }
        }
    }
</script>
